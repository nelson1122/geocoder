import xml, re, psycopg2, ppygis
from xml.dom.minidom import parse

conn_string = "host='localhost' dbname='addresses' user='postgres' password='postgres1'"
pg_conn = psycopg2.connect(conn_string)
cursor = pg_conn.cursor()

xmls = xml.dom.minidom.parse("comuna4.osm")

for n in xmls.getElementsByTagName("node"):
	nid = n.getAttribute("id")
	type_address = ""
	node_tags = {}
	
	#Recorrido y obtencion de las etiquetas de los Puntos, con type_address se define
	#si la direccion es asignada segun la malla vial o segun el caso barrio - manzana - predio
	for tag in n.getElementsByTagName("tag"):
		if tag.hasAttribute("k") and tag.hasAttribute("v"):
			node_tags[tag.getAttribute("k")] = tag.getAttribute("v")
			if tag.getAttribute("k") == "addr:full":
				if re.match("^[MZ]{2}",tag.getAttribute("v")):
					type_address = "nb_type"	
				else:
					type_address = "sn_type"
	
	lat = float(n.getAttribute("lat"))
	lon = float(n.getAttribute("lon"))
	geom = ppygis.Point(lon, lat, srid=4326)
	
	if type_address == "sn_type":
		sql = "INSERT INTO road_network_addresses (id, main_street, secondary_street, distance, address_geometry) VALUES (%s, %s, %s, %s, %s);"
		cursor.execute(sql, (nid, node_tags["addr:street"], node_tags["addr:full"], node_tags["addr:housenumber"], geom))
		#print nid + " " + node_tags["addr:street"] + " " + node_tags["addr:full"] + " " +  node_tags["addr:housenumber"]
		
	elif type_address == "nb_type":
		sql = "INSERT INTO neighborhood_block_houseid_addresses (address_id, block, houseid, address_geometry) VALUES (%s, %s, %s, %s);"
		cursor.execute(sql, (nid, node_tags["addr:full"], node_tags["addr:housenumber"], geom))
		#print nid + " " + node_tags["addr:full"]  + " " + node_tags["addr:housenumber"]
			
cursor.close()
pg_conn.commit()
pg_conn.close()
print 'Migracion completada'
